title: 「JavaScript高级程序设计」变量、作用域和内存问题
date: 2015-01-12 20:09:12
tags: [JavaScript, 阅读笔记]
---

## 变量、作用域和内存问题

4.1  基本类型和引用类型的值
- ECMAScript变量包含两种不同数据类型的值：基本类型和引用类型。
- 基本类型指的是简单的数据字段，如：undefined，null，boolean，number和string。
- 引用类型的值是保存在内存中的对象。JavaScript不允许直接访问内存中的位置，实际操作的是对象的引用。

4.1.1  动态的属性
- 对于引用类型的值，我们可以为其添加属性和方法，也可以改变和删除其属性和方法。
- 对于基本类型，我们不能给基本类型的值添加属性或者方法，尽管这样不会导致任何错误。
- 只能给引用类型的值动态的添加属性和方法。

4.1.2  复制变量值
- 如果一个变量向另一个变量复制基本类型的值，那么会再变量对象上创建一个新值，然后把该值复制到新变量分配的位置上。
  ``` javascript
      // 例如：
      var num1 = 5;
      var num2 = num1;    //  如果此时修改num1的数值，num2不变。
  ```
- 如果一个变量向另一个变量复制引用类型的值，同样也会将变量复制一份放到新分配的空间。与基本类型复制不同的是，这个值的副本实际是一个指针，这两个变量指向同一个对象。
  ``` javascript
      var obj1 = {age: 5};
      var obj2 = obj1;    //  如果此时修改obj1.age，那么obj2.name也会修改。
  ```
4.1.3  传递参数
- 基本类型的值传递时，函数体内的值一旦变化不会影响外部的参数。
- 应用类型的值传递时，函数体内的对象属性一旦发生变化，外部的变量对象也会随之变化。

4.1.4  检测类型
- 通常我们用typeof操作符检测对象类型。
- typeof可以用来确定一个变量是字符串、数值、布尔值、还是undefined。
- 如果变量为null，则会返回object。
- 我们还可以通过instanceof操作符检测对象是否属于引用对象的实例。
  ``` javascript
      // 例如：
      result = variable instanceof constructor
  ```
4.2  执行环境及作用域
- 全局执行环境是最外围的一个执行环境，根据ECMAScript实现的宿主环境不同，表示执行环境的对象也不一样。在Web浏览器中，全部执行环境被认为是window对象。
- 每个函数都有自己的执行环境。
- 在执行环境中时，会创建变量对象的一个作用域链，其用途是保证执行环境中的所有变量和函数有序访问。
- 活动对象始终在作用域链的前端，全局执行环境的变量始终都是作用域链的最后一个对象。

4.2.1  延长作用域链
- 执行环境类型分两种：全局和局部（函数）
- 有些语句可以在作用域链的前端临时增加一个变量对象。
  ``` javascript
      // 如下：
      // try-catch语句的catch块
      // with语句
  ```
- 这两个语句都会在作用域链的前端添加一个变量对象。

4.2.2  没有块级作用域
- 在if语句中定义变量，如果是在C、C++或Java中，变量会在if语句执行完成后被销毁。但在JavaScript中，if语句中的变量声明会添加到当前的执行环境中。
- for语句初始化所定义的变量，即使在for循环执行结束后，也依旧会存在与循环外部的执行环境中。
  - 声明变量
    - 使用var声明的变量会自动被添加到最接近的环境中。在函数内部即为局部函数。
    - 在with语句中，最接近的环境是函数环境。
    - 如果初始化变量时没有使用var声明，该变量会自动添加到全局环境。
  - 查询标识符
    - 查询标识符的搜索过程从作用域链的前端开始，向上逐级查询。如果在局部环境中找到该标识符则停止。如果没有找到则继续向上追溯至全局环境。

4.3  垃圾收集
- JavaScript具有自动垃圾收集机制。执行环境会负责管理代码执行过程中使用的内存。
- 垃圾收集机制的原理：找出那些不再继续使用的变量，然后释放其占用的空间。为此，垃圾收集器会按照固定的时间间隔执行。

4.3.1  标记清除
- 垃圾收集器在运行的过程中会给所有变量都加上标记。它会去掉当前环境中的变量以及引用的变量的标记。在此之后再被加上标记的变量将被视为准备删除的变量，最后垃圾收集器完成内存清除工作。

4.3.2  引用计数
- 引用计数是一种不太常见的垃圾收集策略。
- 当声明了一个引用类型的变量时，则这个值的引用次数为1，如果另外一个变量引用了这个值，则引用次数增加1。如果这个引用值又取得了另外一个值，则引用次数减一。
- 当这个引用类型变量的引用次数变成0时，其所占用的内存空间将被回收。

4.3.3  性能问题
- 垃圾收集器是周期性运行的。
- IE7重写了垃圾收集例程，因为之前IE的垃圾收集器是根据内存分配量运行的，一旦达到相应临界值变，垃圾收集器便会开始频繁运行。

4.3.4  管理内存
- 一旦数据不再用到，最好通过将其值设置为null来释放其引用——这种做法叫做解除引用。这适用于全局变量和全局对象的属性。
- 局部变量会在它们离开执行环境时自动解除引用。
- 解除引用不意味立即清除该值所占用内存，只是让值脱离执行环境，去等待垃圾收集器的回收。